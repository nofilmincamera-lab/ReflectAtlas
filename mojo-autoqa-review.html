<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mojo AutoQA Review | Analyst Stratification</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root {
      --primary-green: #327a6a;
      --dark-indigo: #23194f;
      --accent-indigo: #3b2d6b;
      --neon-pink: #ff4fd8;
      --red: #e34b5b;
      --purple: #8a58f5;
      --blue: #3f8df8;
      --navy: #142748;
      --bg: #0b1020;
      --panel: #0f1730;
      --text: #e8ecff;
      --muted: #aab3d6;
      --grid: #1f2a52;
      --ok: #2ee59d;
      --warn: #ffcc66;
      --risk: #ff5c7a;
      --info: #7aa7ff;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      font-family: "Avenir Next", "Segoe UI", sans-serif;
    }

    body {
      display: grid;
      place-items: center;
      color: var(--text);
      background:
        radial-gradient(1100px 520px at -10% -10%, rgba(50, 122, 106, 0.36), transparent 58%),
        radial-gradient(1000px 520px at 108% -14%, rgba(59, 45, 107, 0.52), transparent 58%),
        radial-gradient(760px 520px at 78% 22%, rgba(255, 79, 216, 0.16), transparent 64%),
        linear-gradient(180deg, #0e1434 0%, #111739 55%, #0d1836 100%);
      padding: 10px;
    }

    .frame {
      width: min(96vw, calc(94vh * 4 / 3));
      height: min(94vh, calc(96vw * 3 / 4));
      aspect-ratio: 4 / 3;
      border-radius: 16px;
      border: 1px solid rgba(255, 79, 216, 0.82);
      background:
        radial-gradient(120% 100% at 10% 0%, rgba(59, 45, 107, 0.32), transparent 56%),
        radial-gradient(120% 100% at 90% 0%, rgba(50, 122, 106, 0.24), transparent 62%),
        rgba(10, 16, 46, 0.56);
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 48px rgba(3, 7, 28, 0.55), 0 0 18px rgba(255, 79, 216, 0.28);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      padding: 10px;
      position: relative;
      isolation: isolate;
    }

    .frame::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        linear-gradient(rgba(122, 167, 255, 0.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(122, 167, 255, 0.04) 1px, transparent 1px);
      background-size: 28px 28px;
      opacity: 0.35;
      pointer-events: none;
      z-index: -1;
    }

    .frame::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 16px;
      box-shadow: inset 0 0 0 1px rgba(255, 79, 216, 0.42), inset 0 40px 80px rgba(122, 167, 255, 0.08);
      pointer-events: none;
      z-index: 2;
    }

    .topbar {
      border: 1px solid rgba(176, 196, 255, 0.24);
      border-radius: 14px;
      padding: 7px 9px;
      background: linear-gradient(165deg, rgba(20, 31, 75, 0.72), rgba(12, 22, 54, 0.56));
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(59, 45, 107, 0.42);
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #dbe6ff;
      white-space: nowrap;
    }

    .pill-icon {
      width: 14px;
      height: 14px;
      border-radius: 6px;
      background: linear-gradient(145deg, var(--primary-green), var(--blue));
      border: 1px solid rgba(255, 255, 255, 0.24);
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tab,
    .action-btn,
    .small-btn {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      padding: 6px 9px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      transition: border-color 160ms ease, transform 160ms ease, background 160ms ease;
    }

    .tab.active {
      border-color: rgba(122, 167, 255, 0.55);
      background: linear-gradient(145deg, rgba(63, 141, 248, 0.32), rgba(59, 45, 107, 0.3));
      box-shadow: 0 0 0 1px rgba(122, 167, 255, 0.25) inset;
    }

    .actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.05);
    }

    .action-btn.micro-cta {
      background: linear-gradient(145deg, rgba(255, 79, 216, 0.34), rgba(59, 45, 107, 0.36));
      border-color: rgba(255, 79, 216, 0.78);
      color: #ffe8fb;
      font-size: 13px;
      font-weight: 700;
      padding: 9px 14px;
      box-shadow: 0 0 16px rgba(255, 79, 216, 0.34);
    }

    .action-btn:hover,
    .small-btn:hover,
    .tab:hover {
      border-color: rgba(255, 255, 255, 0.26);
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }

    .status-chip {
      font-size: 11px;
      color: #d8e6ff;
      border-radius: 999px;
      border: 1px solid rgba(89, 212, 184, 0.4);
      background: rgba(50, 122, 106, 0.28);
      padding: 6px 10px;
      white-space: nowrap;
      box-shadow: 0 0 14px rgba(50, 122, 106, 0.24);
      animation: statusPulse 3.2s ease-in-out infinite;
    }

    @keyframes statusPulse {
      0%, 100% { box-shadow: 0 0 10px rgba(50, 122, 106, 0.16); }
      50% { box-shadow: 0 0 16px rgba(63, 141, 248, 0.25); }
    }

    .pages {
      position: relative;
      border: 1px solid rgba(176, 196, 255, 0.24);
      border-radius: 14px;
      background:
        radial-gradient(140% 120% at 100% -20%, rgba(138, 88, 245, 0.14), transparent 58%),
        radial-gradient(110% 120% at 0% 120%, rgba(50, 122, 106, 0.1), transparent 56%),
        rgba(12, 20, 52, 0.46);
      overflow: hidden;
      min-height: 0;
    }

    .page {
      display: none;
      width: 100%;
      height: 100%;
      padding: 8px;
      overflow: auto;
    }

    .page.active {
      display: block;
    }

    .strat-layout {
      display: grid;
      grid-template-columns: minmax(300px, 330px) 1fr;
      gap: 8px;
      height: 100%;
    }

    .strat-layout.expanded {
      grid-template-columns: 1fr;
    }

    .strat-layout.expanded #side {
      display: none;
    }

    .panel {
      background: linear-gradient(165deg, rgba(15, 23, 48, 0.88), rgba(12, 21, 50, 0.74));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      padding: 10px;
      overflow: auto;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }

    .panel h2 {
      margin: 0 0 10px;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .kpis {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .kpi {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 8px;
    }

    .kpi .label {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .kpi .value {
      font-size: 18px;
      font-weight: 700;
      line-height: 1.1;
    }

    .kpi .sub {
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      margin: 8px 0;
    }

    .chip {
      font-size: 10px;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
      white-space: nowrap;
    }

    .chip b {
      color: var(--text);
      font-weight: 700;
    }

    .details {
      margin-top: 10px;
    }

    .details .title {
      font-size: 12px;
      font-weight: 700;
      margin: 0 0 6px;
      color: #f4f7ff;
    }

    .details .row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 7px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 11px;
    }

    .details .row span {
      color: var(--muted);
      text-align: right;
    }

    .legend {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 9px;
      font-size: 10px;
      color: var(--muted);
    }

    .legend .item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
    }

    .canvas {
      position: relative;
      min-height: 100%;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 8px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .toolbar .sep {
      flex: 1 1 auto;
    }

    .toolbar .small {
      font-size: 11px;
      color: var(--muted);
    }

    .hint {
      position: absolute;
      right: 12px;
      top: 52px;
      font-size: 10px;
      color: var(--muted);
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 6px 9px;
      border-radius: 10px;
      backdrop-filter: blur(6px);
      z-index: 1;
    }

    svg {
      width: 100%;
      height: 100%;
      min-height: clamp(360px, 46vh, 540px);
    }

    .tooltip {
      position: fixed;
      pointer-events: none;
      opacity: 0;
      background: rgba(7, 11, 23, 0.96);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
      padding: 9px 11px;
      border-radius: 11px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      font-size: 12px;
      max-width: 320px;
      z-index: 50;
    }

    .tooltip .t {
      font-weight: 800;
      margin-bottom: 5px;
    }

    .tooltip .m {
      color: var(--muted);
      line-height: 1.35;
    }

    .context-grid,
    .notes-grid {
      display: grid;
      grid-template-columns: 1.15fr 1fr;
      gap: 10px;
      height: 100%;
    }

    .title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .title-row h3 {
      margin: 0;
      font-size: 13px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #eaf0ff;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.06);
      padding: 4px 8px;
      font-size: 10px;
      color: #dae5ff;
      white-space: nowrap;
    }

    .context-list,
    .note-list,
    .activity-list {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
      font-size: 12px;
      color: #dce6ff;
      line-height: 1.4;
    }

    .micro-box {
      margin-top: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 9px;
      background: linear-gradient(160deg, rgba(59, 45, 107, 0.28), rgba(20, 39, 72, 0.28));
      scroll-margin-top: 12px;
      transition: box-shadow 220ms ease, border-color 220ms ease;
    }

    .micro-box.flash {
      border-color: rgba(255, 79, 216, 0.84);
      box-shadow: 0 0 20px rgba(255, 79, 216, 0.3);
    }

    .micro-box p {
      margin: 0 0 8px;
      font-size: 11px;
      color: #d8e4ff;
      line-height: 1.4;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }

    .table th,
    .table td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      padding: 6px;
      text-align: left;
    }

    .table th {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.03em;
    }

    .note-box {
      width: 100%;
      min-height: 110px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(10, 18, 45, 0.76);
      color: #edf2ff;
      padding: 9px;
      resize: vertical;
      font-family: inherit;
      font-size: 12px;
    }

    .note-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .note-media {
      margin-top: 7px;
    }

    .note-media img {
      display: block;
      width: min(100%, 380px);
      height: auto;
      border-radius: 10px;
      border: 1px solid rgba(255, 79, 216, 0.46);
      box-shadow: 0 0 14px rgba(255, 79, 216, 0.24);
    }

    .empty {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
    }

    .modal {
      position: absolute;
      inset: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(6, 10, 28, 0.9);
      backdrop-filter: blur(8px);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.42);
      padding: 12px;
      overflow: auto;
      z-index: 30;
    }

    .modal.hide {
      display: none;
    }

    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .modal-head h4 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #edf2ff;
    }

    .modal-body {
      font-size: 12px;
      color: #dbe6ff;
      line-height: 1.45;
    }

    .modal-body ul {
      margin: 8px 0 0;
      padding-left: 18px;
      display: grid;
      gap: 5px;
    }

    @media (max-width: 1200px) {
      .frame {
        width: 100vw;
        height: 100vh;
        aspect-ratio: auto;
        border-radius: 0;
      }

      .strat-layout,
      .context-grid,
      .notes-grid {
        grid-template-columns: 1fr;
      }

      .actions {
        margin-left: 0;
      }

      svg {
        min-height: 420px;
      }
    }
  </style>
</head>
<body>
  <div class="frame">
    <header class="topbar">
      <div class="brand"><span class="pill-icon"></span>Mojo AutoQA Analyst View</div>
      <div class="tabs">
        <button class="tab active" data-page-btn="strat">Page 1: Stratification</button>
        <button class="tab" data-page-btn="context">Page 2: Context</button>
        <button class="tab" data-page-btn="notes">Page 3: Analyst Notes</button>
      </div>
      <div class="actions">
        <button class="action-btn micro-cta" id="btnMicro">Microlearning</button>
        <button class="action-btn" id="btnContext">Provide Context</button>
        <button class="action-btn" id="btnDrill">Drill Down</button>
        <button class="action-btn" id="btnExpand">Expand View</button>
        <span id="activeStatus" class="status-chip">Selected: All Calls</span>
      </div>
    </header>

    <section class="pages">
      <section class="page active" data-page="strat">
        <div class="strat-layout" id="stratLayout">
          <aside class="panel" id="side">
            <h2>QA Stratification</h2>

            <div class="kpis">
              <div class="kpi">
                <div class="label">Population</div>
                <div class="value" id="kpi-pop">100%</div>
                <div class="sub">Steam wand failure calls</div>
              </div>
              <div class="kpi">
                <div class="label">Avg Handle Time</div>
                <div class="value" id="kpi-aht">12:40</div>
                <div class="sub">vs 8:15 baseline</div>
              </div>
              <div class="kpi">
                <div class="label">Compliance Risk</div>
                <div class="value" id="kpi-risk">High</div>
                <div class="sub">Warranty/SOP gates</div>
              </div>
              <div class="kpi">
                <div class="label">Sentiment Lift</div>
                <div class="value" id="kpi-sent">+15</div>
                <div class="sub">Frustrated to Satisfied</div>
              </div>
            </div>

            <div class="chips">
              <div class="chip">Warranty verified <b>88%</b></div>
              <div class="chip">SOP not followed <b>27%</b></div>
              <div class="chip">Replacement w/o SOP <b>18%</b></div>
              <div class="chip">Sentiment improved <b>81%</b></div>
            </div>

            <div class="details">
              <div class="title" id="sel-title">Click a node</div>
              <div class="row"><div>Path %</div><span id="sel-pct">-</span></div>
              <div class="row"><div>AHT (avg)</div><span id="sel-aht">-</span></div>
              <div class="row"><div>Flag</div><span id="sel-flag">-</span></div>
              <div class="row"><div>Notes</div><span id="sel-notes">-</span></div>
            </div>

            <div class="legend">
              <div class="item"><span class="dot" style="background:var(--ok)"></span>OK</div>
              <div class="item"><span class="dot" style="background:var(--warn)"></span>Watch</div>
              <div class="item"><span class="dot" style="background:var(--risk)"></span>Risk</div>
              <div class="item"><span class="dot" style="background:var(--info)"></span>Info</div>
            </div>
          </aside>

          <main class="panel canvas">
            <div class="toolbar">
              <button class="small-btn" id="expandAll">Expand all</button>
              <button class="small-btn" id="collapseAll">Collapse all</button>
              <button class="small-btn" id="resetZoom">Reset zoom</button>
              <div class="sep"></div>
              <div class="small">Hover for tooltip. Click node to pin details.</div>
            </div>

            <div class="hint">QA Drilldown Tree</div>
            <svg id="chart" role="img" aria-label="QA Call Stratification Tree"></svg>
          </main>
        </div>
      </section>

      <section class="page" data-page="context">
        <div class="context-grid">
          <article class="panel">
            <div class="title-row">
              <h3>Context Pack</h3>
              <span class="pill" id="contextNodeName">All Calls</span>
            </div>
            <p id="contextNarrative" style="margin:0 0 10px;font-size:12px;color:#dbe6ff;line-height:1.45"></p>
            <ul id="contextActions" class="context-list"></ul>

            <table class="table">
              <thead>
                <tr>
                  <th>Child Path</th>
                  <th>%</th>
                  <th>AHT</th>
                  <th>Flag</th>
                </tr>
              </thead>
              <tbody id="drillRows"></tbody>
            </table>
          </article>

          <article class="panel">
            <div class="title-row">
              <h3>Analyst Activity</h3>
              <span class="pill" id="activityCount">0 events</span>
            </div>
            <ul id="activityLog" class="activity-list"></ul>

            <div class="micro-box" id="microPanel">
              <div class="title-row" style="margin-bottom:6px">
                <h3>Microlearning Launcher</h3>
                <span class="pill" id="microLevel">Core</span>
              </div>
              <p id="microSummary"></p>
              <ul id="microObjectives" class="context-list"></ul>
              <div class="note-actions">
                <button class="small-btn" id="queueMicro">Queue Microlearning</button>
                <button class="small-btn" id="openNotesFromMicro">Open Notes Page</button>
              </div>
            </div>
          </article>
        </div>
      </section>

      <section class="page" data-page="notes">
        <div class="notes-grid">
          <article class="panel">
            <div class="title-row">
              <h3>Write Note</h3>
              <span class="pill" id="noteTarget">Target: All Calls</span>
            </div>
            <textarea id="noteInput" class="note-box" placeholder="Capture QA findings, coachable moments, and follow-up recommendations..."></textarea>
            <div class="note-actions">
              <button class="small-btn" id="addNote">Log note</button>
              <button class="small-btn" id="clearNotes">Clear all notes</button>
              <span class="status-chip" id="noteCount">0 notes</span>
            </div>
          </article>

          <article class="panel">
            <div class="title-row">
              <h3>Logged Notes</h3>
              <span class="pill">Persistent</span>
            </div>
            <ul id="noteList" class="note-list"></ul>
            <p id="noteEmpty" class="empty">No notes logged yet.</p>
          </article>
        </div>
      </section>

      <article id="drillModal" class="modal hide">
        <div class="modal-head">
          <h4 id="drillTitle">Drill Down Snapshot</h4>
          <button class="small-btn" id="closeDrill">Close</button>
        </div>
        <div class="modal-body" id="drillBody"></div>
      </article>
    </section>
  </div>

  <div class="tooltip" id="tip"></div>

  <script>
    const data = {
      name: "All Calls",
      pct: 100,
      aht: "12:40",
      flag: "info",
      notes: "Steam wand failure population (100% interactions scored).",
      children: [
        {
          name: "Warranty Verified?",
          pct: 100,
          aht: "12:40",
          flag: "info",
          notes: "Compliance gate: verify warranty before replacement actions.",
          children: [
            {
              name: "Yes",
              pct: 88,
              aht: "11:55",
              flag: "ok",
              notes: "Warranty confirmed.",
              children: [
                {
                  name: "SOP Followed? (Troubleshooting Sequence)",
                  pct: 88,
                  aht: "11:55",
                  flag: "info",
                  notes: "Purge cycle then thermoblock reset before replacement path.",
                  children: [
                    {
                      name: "Yes",
                      pct: 61,
                      aht: "9:05",
                      flag: "ok",
                      notes: "Sequence followed in order.",
                      children: [
                        { name: "Outcome: Replacement Authorized", pct: 45, aht: "9:10", flag: "ok", notes: "Troubleshooting exhausted; replacement created." },
                        { name: "Outcome: Resolved (Troubleshooting)", pct: 11, aht: "7:05", flag: "ok", notes: "Issue fixed via purge/reset." },
                        { name: "Outcome: Repair Depot", pct: 5, aht: "10:40", flag: "warn", notes: "Repair option used; longer cycle time." }
                      ]
                    },
                    {
                      name: "No",
                      pct: 27,
                      aht: "13:05",
                      flag: "warn",
                      notes: "Steps skipped or out of order; higher AHT.",
                      children: [
                        { name: "Outcome: Replacement Issued Anyway", pct: 18, aht: "12:55", flag: "risk", notes: "Cost leakage and inconsistent policy execution." },
                        { name: "Outcome: Escalated to Supervisor", pct: 7, aht: "13:40", flag: "warn", notes: "Increased AHT; agent uncertainty." },
                        { name: "Outcome: Callback Required", pct: 2, aht: "14:30", flag: "warn", notes: "Customer effort and dissatisfaction risk." }
                      ]
                    }
                  ]
                },
                {
                  name: "Sentiment Shift",
                  pct: 88,
                  aht: "11:55",
                  flag: "info",
                  notes: "AutoQA sentiment delta classification.",
                  children: [
                    { name: "Frustrated to Satisfied", pct: 52, aht: "11:20", flag: "ok", notes: "Strong recovery with clear resolution." },
                    { name: "Neutral to Satisfied", pct: 29, aht: "10:50", flag: "ok", notes: "Smooth service and clear next steps." },
                    { name: "Frustrated to Frustrated", pct: 7, aht: "14:10", flag: "risk", notes: "Watch for missed empathy and unclear policy explanation." }
                  ]
                }
              ]
            },
            {
              name: "No",
              pct: 12,
              aht: "14:20",
              flag: "risk",
              notes: "Compliance exposure: warranty not explicitly verified.",
              children: [
                { name: "Replacement Offered", pct: 6, aht: "14:35", flag: "risk", notes: "High-risk replacement without validation." },
                { name: "Repair Quoted / Denied Coverage", pct: 6, aht: "14:05", flag: "warn", notes: "Potential CX impact if policy is unclear." }
              ]
            }
          ]
        },
        {
          name: "Escalation Required",
          pct: 10,
          aht: "13:30",
          flag: "warn",
          notes: "Non-standard issues that drive handle time.",
          children: [
            { name: "Shipping / Address Issue", pct: 4, aht: "13:10", flag: "warn", notes: "Verification loops and address mismatch." },
            { name: "System / Ticket Failure", pct: 3, aht: "14:00", flag: "risk", notes: "Tooling friction; add SOP fallback." },
            { name: "Policy Exception Requested", pct: 3, aht: "13:25", flag: "warn", notes: "Edge cases; route with guardrails." }
          ]
        }
      ]
    };

    const state = {
      selectedNode: null,
      page: "strat",
      expanded: false,
      notes: []
    };

    const microlearningGifPath = "./2023_Animated_Product-Mock-1.gif";

    const ui = {
      tabs: Array.from(document.querySelectorAll("[data-page-btn]")),
      pages: Array.from(document.querySelectorAll("[data-page]")),
      activeStatus: document.getElementById("activeStatus"),
      btnMicro: document.getElementById("btnMicro"),
      btnContext: document.getElementById("btnContext"),
      btnDrill: document.getElementById("btnDrill"),
      btnExpand: document.getElementById("btnExpand"),
      stratLayout: document.getElementById("stratLayout"),
      selTitle: document.getElementById("sel-title"),
      selPct: document.getElementById("sel-pct"),
      selAht: document.getElementById("sel-aht"),
      selFlag: document.getElementById("sel-flag"),
      selNotes: document.getElementById("sel-notes"),
      contextNodeName: document.getElementById("contextNodeName"),
      contextNarrative: document.getElementById("contextNarrative"),
      contextActions: document.getElementById("contextActions"),
      drillRows: document.getElementById("drillRows"),
      activityLog: document.getElementById("activityLog"),
      activityCount: document.getElementById("activityCount"),
      microPanel: document.getElementById("microPanel"),
      microLevel: document.getElementById("microLevel"),
      microSummary: document.getElementById("microSummary"),
      microObjectives: document.getElementById("microObjectives"),
      queueMicro: document.getElementById("queueMicro"),
      openNotesFromMicro: document.getElementById("openNotesFromMicro"),
      noteTarget: document.getElementById("noteTarget"),
      noteInput: document.getElementById("noteInput"),
      addNote: document.getElementById("addNote"),
      clearNotes: document.getElementById("clearNotes"),
      noteList: document.getElementById("noteList"),
      noteCount: document.getElementById("noteCount"),
      noteEmpty: document.getElementById("noteEmpty"),
      drillModal: document.getElementById("drillModal"),
      drillTitle: document.getElementById("drillTitle"),
      drillBody: document.getElementById("drillBody"),
      closeDrill: document.getElementById("closeDrill"),
      expandAll: document.getElementById("expandAll"),
      collapseAll: document.getElementById("collapseAll"),
      resetZoom: document.getElementById("resetZoom"),
      tip: document.getElementById("tip")
    };

    if (typeof window.d3 === "undefined") {
      document.body.innerHTML = "<p style='padding:20px;color:#fff'>D3 failed to load. Check network access for https://cdn.jsdelivr.net/npm/d3@7</p>";
      throw new Error("D3 failed to load.");
    }

    const tip = d3.select("#tip");
    const svg = d3.select("#chart");
    const g = svg.append("g");
    const margin = { top: 20, right: 30, bottom: 20, left: 30 };
    let width = 800;
    let height = 520;
    let idCounter = 0;
    const duration = 220;
    let zoom;

    const root = d3.hierarchy(data);
    root.x0 = height / 2;
    root.y0 = 0;

    function getCSS(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function flagColor(flag) {
      switch (flag) {
        case "ok": return getCSS("--ok");
        case "warn": return getCSS("--warn");
        case "risk": return getCSS("--risk");
        default: return getCSS("--info");
      }
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function setPage(page) {
      state.page = page;
      ui.tabs.forEach(btn => btn.classList.toggle("active", btn.dataset.pageBtn === page));
      ui.pages.forEach(panel => panel.classList.toggle("active", panel.dataset.page === page));
      logActivity("Page changed to " + page + ".");
      resize();
    }

    function collapse(node) {
      if (node.children) {
        node._children = node.children;
        node._children.forEach(collapse);
        node.children = null;
      }
    }

    function expand(node) {
      if (node._children) {
        node.children = node._children;
        node._children = null;
      }
      if (node.children) {
        node.children.forEach(expand);
      }
    }

    function setSelection(node) {
      state.selectedNode = node;
      const d = node.data;
      ui.selTitle.textContent = d.name || "-";
      ui.selPct.textContent = Number.isFinite(d.pct) ? d.pct + "%" : "-";
      ui.selAht.textContent = d.aht || "-";
      ui.selFlag.textContent = (d.flag || "-").toUpperCase();
      ui.selNotes.textContent = d.notes || "-";
      ui.activeStatus.textContent = "Selected: " + d.name;
      ui.noteTarget.textContent = "Target: " + d.name;
      renderContext(node);
    }

    function contextRecommendations(node) {
      const flag = node.data.flag;
      if (flag === "risk") {
        return [
          "Trigger manual QA review for this path in next audit cycle.",
          "Assign targeted coaching focused on policy adherence.",
          "Monitor repeat-contact behavior for the next 14 days."
        ];
      }
      if (flag === "warn") {
        return [
          "Add microlearning reminder before this call stage.",
          "Review top transcript moments to lower handle time.",
          "Validate if escalation thresholds are clear to agents."
        ];
      }
      if (flag === "ok") {
        return [
          "Promote this path as a best-practice example.",
          "Capture key phrases that improved customer confidence.",
          "Use this branch as calibration baseline."
        ];
      }
      return [
        "Use this node as a routing checkpoint for QA segmentation.",
        "Compare branch-level sentiment against weekly trend.",
        "Track changes after coaching rollout."
      ];
    }

    function microlearningPlan(node) {
      const d = node.data;
      const flag = d.flag || "info";

      if (flag === "risk") {
        return {
          level: "Urgent",
          summary: "Fast-track module focused on policy recovery and compliance-safe resolution behavior.",
          objectives: [
            "Reinforce warranty verification and required disclosures before replacement.",
            "Practice handling high-friction customer moments without skipping SOP steps.",
            "Reduce repeat contacts using complete close-out confirmation language."
          ]
        };
      }

      if (flag === "warn") {
        return {
          level: "Priority",
          summary: "Refresher module to tighten troubleshooting sequence and reduce avoidable handle-time drag.",
          objectives: [
            "Execute purge-cycle and thermoblock reset in strict order.",
            "Use branch-based phrasing to keep customer confidence high.",
            "Identify early triggers for escalation versus standard resolution."
          ]
        };
      }

      if (flag === "ok") {
        return {
          level: "Reinforce",
          summary: "Best-practice booster to replicate high-performing behavior across new agents.",
          objectives: [
            "Capture high-impact language patterns from successful calls.",
            "Template strong call flow from greeting through close.",
            "Use this branch as a calibration benchmark in QA reviews."
          ]
        };
      }

      return {
        level: "Core",
        summary: "Baseline learning path that connects trend diagnostics to coaching and measurable QA outcomes.",
        objectives: [
          "Map call branches to QA risk categories.",
          "Pair sentiment movement with resolution quality.",
          "Set review cadence for weekly performance calibration."
        ]
      };
    }

    function renderMicrolearning(node) {
      const plan = microlearningPlan(node);
      ui.microLevel.textContent = plan.level;
      ui.microSummary.textContent = plan.summary;
      ui.microObjectives.innerHTML = plan.objectives
        .map(item => "<li>" + escapeHtml(item) + "</li>")
        .join("");
    }

    function renderContext(node) {
      const d = node.data;
      const actions = contextRecommendations(node);
      ui.contextNodeName.textContent = d.name;
      ui.contextNarrative.textContent =
        "Node " + d.name + " represents " + (Number.isFinite(d.pct) ? d.pct + "%" : "-") +
        " of population with average handle time " + (d.aht || "-") +
        ". Current flag is " + (d.flag || "info").toUpperCase() + ".";

      ui.contextActions.innerHTML = actions.map(item => "<li>" + escapeHtml(item) + "</li>").join("");

      const children = node.children || node._children || [];
      if (!children.length) {
        ui.drillRows.innerHTML = "<tr><td colspan=\"4\">No deeper branch from this node.</td></tr>";
      } else {
        ui.drillRows.innerHTML = children.map(child => {
          const cd = child.data;
          return "<tr>" +
            "<td>" + escapeHtml(cd.name) + "</td>" +
            "<td>" + (Number.isFinite(cd.pct) ? cd.pct + "%" : "-") + "</td>" +
            "<td>" + escapeHtml(cd.aht || "-") + "</td>" +
            "<td>" + escapeHtml((cd.flag || "info").toUpperCase()) + "</td>" +
            "</tr>";
        }).join("");
      }

      renderMicrolearning(node);
    }

    function renderDrillModal() {
      const node = state.selectedNode;
      const d = node.data;
      const children = node.children || node._children || [];
      ui.drillTitle.textContent = "Drill Down: " + d.name;

      let childSummary = "<li>No child paths found at this level.</li>";
      if (children.length) {
        childSummary = children.map(child => {
          const cd = child.data;
          return "<li><b>" + escapeHtml(cd.name) + "</b> - " +
            (Number.isFinite(cd.pct) ? cd.pct + "%" : "-") +
            " | AHT " + escapeHtml(cd.aht || "-") +
            " | " + escapeHtml((cd.flag || "info").toUpperCase()) +
            "</li>";
        }).join("");
      }

      ui.drillBody.innerHTML =
        "<p><b>Node:</b> " + escapeHtml(d.name) + "</p>" +
        "<p><b>Path Share:</b> " + (Number.isFinite(d.pct) ? d.pct + "%" : "-") +
        " | <b>Avg AHT:</b> " + escapeHtml(d.aht || "-") +
        " | <b>Flag:</b> " + escapeHtml((d.flag || "info").toUpperCase()) + "</p>" +
        "<p><b>Analyst Context:</b> " + escapeHtml(d.notes || "No notes available.") + "</p>" +
        "<p><b>Next Branches</b></p><ul>" + childSummary + "</ul>";

      ui.drillModal.classList.remove("hide");
    }

    function closeDrillModal() {
      ui.drillModal.classList.add("hide");
    }

    function logActivity(message) {
      const now = new Date();
      const stamp = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      const entry = "[" + stamp + "] " + message;
      const li = document.createElement("li");
      li.textContent = entry;
      ui.activityLog.prepend(li);

      while (ui.activityLog.children.length > 20) {
        ui.activityLog.removeChild(ui.activityLog.lastChild);
      }
      ui.activityCount.textContent = ui.activityLog.children.length + " events";
    }

    function loadNotes() {
      try {
        const raw = localStorage.getItem("mojoAutoQaNotesV2");
        state.notes = raw ? JSON.parse(raw) : [];
      } catch (error) {
        state.notes = [];
      }
      renderNotes();
    }

    function saveNotes() {
      localStorage.setItem("mojoAutoQaNotesV2", JSON.stringify(state.notes));
    }

    function renderNotes() {
      if (!state.notes.length) {
        ui.noteList.innerHTML = "";
        ui.noteEmpty.style.display = "block";
      } else {
        ui.noteEmpty.style.display = "none";
        ui.noteList.innerHTML = state.notes.map(note => {
          const media = note.gif
            ? "<div class=\"note-media\"><img src=\"" + escapeHtml(note.gif) + "\" alt=\"Microlearning preview\" loading=\"lazy\" /></div>"
            : "";
          return "<li><b>" + escapeHtml(note.time) + "</b> - " +
            escapeHtml(note.node) + " - " + escapeHtml(note.text) + media + "</li>";
        }).join("");
      }
      ui.noteCount.textContent = state.notes.length + " notes";
    }

    function addNote() {
      const text = ui.noteInput.value.trim();
      if (!text) {
        return;
      }
      const now = new Date();
      const note = {
        time: now.toLocaleString(),
        node: state.selectedNode ? state.selectedNode.data.name : "All Calls",
        text
      };
      state.notes.unshift(note);
      ui.noteInput.value = "";
      saveNotes();
      renderNotes();
      logActivity("Analyst note added for " + note.node + ".");
    }

    function clearNotes() {
      state.notes = [];
      saveNotes();
      renderNotes();
      logActivity("All notes cleared.");
    }

    function resize() {
      const rect = svg.node().getBoundingClientRect();
      width = rect.width;
      height = Math.max(rect.height, 500);
      svg.attr("viewBox", [0, 0, width, height]);
      render();
    }

    function render() {
      const tree = d3.tree().nodeSize([34, 230]);
      tree(root);

      const link = d3.linkHorizontal().x(d => d.y).y(d => d.x);
      const links = root.links();
      const nodes = root.descendants();

      const linkSel = g.selectAll("path.link")
        .data(links, d => d.target.id || (d.target.id = ++idCounter));

      linkSel.enter()
        .append("path")
        .attr("class", "link")
        .attr("fill", "none")
        .attr("stroke", getCSS("--grid"))
        .attr("stroke-width", 1.6)
        .attr("opacity", 0.9)
        .attr("d", () => {
          const o = { x: root.x0, y: root.y0 };
          return link({ source: o, target: o });
        })
        .merge(linkSel)
        .transition().duration(duration)
        .attr("d", link);

      linkSel.exit()
        .transition().duration(duration)
        .attr("d", () => {
          const o = { x: root.x, y: root.y };
          return link({ source: o, target: o });
        })
        .remove();

      const nodeSel = g.selectAll("g.node")
        .data(nodes, d => d.id || (d.id = ++idCounter));

      const nodeEnter = nodeSel.enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", "translate(" + root.y0 + "," + root.x0 + ")")
        .style("cursor", "pointer")
        .on("click", (event, d) => {
          if (d.children) {
            d._children = d.children;
            d.children = null;
          } else if (d._children) {
            d.children = d._children;
            d._children = null;
          }
          setSelection(d);
          logActivity("Node selected: " + d.data.name + ".");
          render();
        })
        .on("mousemove", (event, d) => {
          tip.style("opacity", 1);
          tip.html(
            "<div class=\"t\">" + escapeHtml(d.data.name) + "</div>" +
            "<div class=\"m\">" +
            "<div><b>Path %:</b> " + (Number.isFinite(d.data.pct) ? d.data.pct + "%" : "-") + "</div>" +
            "<div><b>AHT:</b> " + escapeHtml(d.data.aht || "-") + "</div>" +
            "<div><b>Flag:</b> " + escapeHtml((d.data.flag || "info").toUpperCase()) + "</div>" +
            (d.data.notes ? "<div style=\"margin-top:6px;color:var(--muted)\">" + escapeHtml(d.data.notes) + "</div>" : "") +
            "</div>"
          );
          const pad = 14;
          const x = Math.min(window.innerWidth - 340, event.clientX + pad);
          const y = Math.min(window.innerHeight - 160, event.clientY + pad);
          tip.style("left", x + "px").style("top", y + "px");
        })
        .on("mouseleave", () => tip.style("opacity", 0));

      nodeEnter.append("circle")
        .attr("r", 0)
        .attr("fill", d => flagColor(d.data.flag))
        .attr("stroke", "rgba(255,255,255,.22)")
        .attr("stroke-width", 1.2);

      nodeEnter.append("rect")
        .attr("x", 16)
        .attr("y", -14)
        .attr("rx", 10)
        .attr("ry", 10)
        .attr("height", 28)
        .attr("width", 10)
        .attr("fill", "rgba(255,255,255,.04)")
        .attr("stroke", "rgba(255,255,255,.08)")
        .attr("stroke-width", 1);

      nodeEnter.append("text")
        .attr("x", 26)
        .attr("dy", "0.32em")
        .attr("fill", getCSS("--text"))
        .attr("font-size", 12)
        .attr("font-weight", 650)
        .text(d => d.data.name);

      nodeEnter.append("text")
        .attr("x", 26)
        .attr("dy", "1.65em")
        .attr("fill", getCSS("--muted"))
        .attr("font-size", 11)
        .text(d => Number.isFinite(d.data.pct) ? d.data.pct + "%" : "");

      const nodeMerge = nodeEnter.merge(nodeSel);

      nodeMerge.transition().duration(duration)
        .attr("transform", d => "translate(" + (d.y + margin.left) + "," + (d.x + margin.top) + ")");

      nodeMerge.select("circle")
        .transition().duration(duration)
        .attr("r", d => {
          const p = Number.isFinite(d.data.pct) ? d.data.pct : 0;
          return 6 + Math.max(0, Math.min(10, p / 12));
        })
        .attr("fill", d => flagColor(d.data.flag));

      nodeMerge.each(function() {
        const node = d3.select(this);
        const textNodes = node.selectAll("text").nodes();
        const w1 = textNodes[0] ? textNodes[0].getComputedTextLength() : 0;
        const w2 = textNodes[1] ? textNodes[1].getComputedTextLength() : 0;
        const w = Math.max(w1, w2) + 22;
        node.select("rect").attr("width", Math.max(60, w));
      });

      nodeSel.exit()
        .transition().duration(duration)
        .attr("transform", "translate(" + (root.y + margin.left) + "," + (root.x + margin.top) + ")")
        .remove();

      root.each(d => {
        d.x0 = d.x;
        d.y0 = d.y;
      });
    }

    function wireActions() {
      ui.tabs.forEach(btn => {
        btn.addEventListener("click", () => setPage(btn.dataset.pageBtn));
      });

      ui.btnMicro.addEventListener("click", () => {
        setPage("context");
        ui.microPanel.classList.add("flash");
        ui.microPanel.scrollIntoView({ behavior: "smooth", block: "start" });
        window.setTimeout(() => ui.microPanel.classList.remove("flash"), 1100);
        logActivity("Microlearning panel opened for " + state.selectedNode.data.name + ".");
      });

      ui.btnContext.addEventListener("click", () => {
        setPage("context");
        logActivity("Context requested for " + state.selectedNode.data.name + ".");
      });

      ui.btnDrill.addEventListener("click", () => {
        renderDrillModal();
        setPage("context");
        logActivity("Drill down opened for " + state.selectedNode.data.name + ".");
      });

      ui.btnExpand.addEventListener("click", () => {
        state.expanded = !state.expanded;
        ui.stratLayout.classList.toggle("expanded", state.expanded);
        ui.btnExpand.textContent = state.expanded ? "Exit Expand" : "Expand View";
        logActivity(state.expanded ? "Expand mode enabled." : "Expand mode disabled.");
        resize();
      });

      ui.closeDrill.addEventListener("click", closeDrillModal);

      ui.expandAll.addEventListener("click", () => {
        expand(root);
        render();
        logActivity("All branches expanded.");
      });

      ui.collapseAll.addEventListener("click", () => {
        root.children && root.children.forEach(collapse);
        render();
        logActivity("Deep branches collapsed.");
      });

      ui.resetZoom.addEventListener("click", () => {
        svg.transition().duration(250).call(zoom.transform, d3.zoomIdentity);
        logActivity("Zoom reset.");
      });

      ui.addNote.addEventListener("click", addNote);
      ui.clearNotes.addEventListener("click", clearNotes);

      ui.queueMicro.addEventListener("click", () => {
        const node = state.selectedNode || root;
        const plan = microlearningPlan(node);
        const now = new Date();
        const note = {
          time: now.toLocaleString(),
          node: node.data.name,
          text: "[Microlearning " + plan.level + "] " + plan.summary,
          gif: microlearningGifPath
        };

        state.notes.unshift(note);
        saveNotes();
        renderNotes();
        setPage("notes");
        logActivity("Microlearning queued for " + node.data.name + " with GIF.");
      });

      ui.openNotesFromMicro.addEventListener("click", () => {
        setPage("notes");
        logActivity("Navigated to notes from microlearning panel.");
      });

      window.addEventListener("resize", resize);
      document.addEventListener("keydown", event => {
        if (event.key === "Escape") {
          closeDrillModal();
        }
      });
    }

    zoom = d3.zoom()
      .scaleExtent([0.6, 2.2])
      .on("zoom", event => g.attr("transform", event.transform));
    svg.call(zoom);

    root.children && root.children.forEach(d => {
      d.children && d.children.forEach(collapse);
    });

    setSelection(root);
    wireActions();
    loadNotes();
    logActivity("Session initialized.");
    resize();
  </script>
</body>
</html>
